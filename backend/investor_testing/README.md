# Общее описание сервиса

Сервис тестирования инвесторов от команды [Ньютон Технологии](https://nwtn.io/).

Newton TONI - сервис тестирования неквалифицированных инвесторов. Сервис позволяет
клиентам брокера пройти тестирование в удобном web-интерфейсе, а брокеру вести учет
пройденных тестов в отдельной базе данных.

[Описание API](https://api.nwtn.io/open-api/investor_testing/)

## Зачем нужно тестирование?

С 1 октября 2021 года вступают в силу поправки в закон о рынке ценных бумаг.
Теперь неквалифицированные инвесторы будут обязаны пройти тестирование,
чтобы получить доступ к сложным финансовым инструментам.
Порядок тестирования определяется базовым стандартом, который разрабатывают
саморегулируемые организации - НАУФОР и СРО НФА.

## Функции сервиса:

- Идентификация пользователя по подтвержденному email.
- Тестирование клиентов в web-интерфейсе.
- Возможно проходить тест несколько раз.
- История пройденных тестов.
- Уведомление на email о пройденных тестах.
- Экспорт результатов тестирования клиентов в формате CSV.
- Возможность подключения собственного личного кабинета брокера по API.

## Архитектура сервиса

Сервис состоит из трех основных частей:

- Бэкенд модуль, который предоставляет REST API ([спецификация OpenAPI](https://api.nwtn.io/open-api/investor_testing/)). Состоит издвух частей:
базы данных PostgreSQL и кода на PHP/Lumen, который реализует API.
- Web-приложение (React), которое использует REST API.
- Админский дашборд (React), который так же подключается по REST API к бэкенд модулю.

## Преимущества сервиса

- Соответствие всем требованиям базового стандарта.
- Простая установка с помощью Docker-контейнеров.
- Возможность проводить тестирование клиентов без интеграции с внешними системами.
- Открытый код и спецификации интерфейсов взаимодействия

## Лицензия

_WIP_

# Установка

## Database

_WIP_

## Backend

_WIP_

### Генерация ключа приложения

Необходимо сгенерировать ключ приложения (подробнее о ключе можно прочитать
в [документации фреймворка](https://lumen.laravel.com/docs/8.x/installation)).

Ключ обычно представляет собой строку из 32 случайных символов.

Сгенерированный ключ следует задать в файле `./.env`

```
APP_KEY=str32_random_string
```

### Создание ключей авторизации

Приложение имеет встроенный сервер авторизации, для функционирования которого необходимо
создать пару ключей (private и public).

Создать ключи можно при помощи openssl:

```
$ openssl genrsa -out private.pem 3072
$ openssl rsa -in private.pem -pubout -out public.pem
```

Полученные ключи `private.pem`, `public.pem` следует поместить в корневую директорию проекта.
Никому не передавайте ваш приватный ключ.

## Frontend

_WIP_

# Настройка

Конфигурация сервиса задается в файле `./.env`. После установки зависимостей можно
создать этот файл копированием из `./env.example`. Основные доступные параметры описаны в следующих таблицах.

## Параметры базовой настройки приложения

| Параметр                  | По умолчанию     | Описание
| --------------------------| ---------------- | --------
| APP_NAME                  | Newton TONI      | Имя приложения, в данный момент не используется
| APP_ENV                   | production       | Имя окружения, важно установить production для продакшн системы
| APP_DEBUG                 | false            | Признак режима отладки, оставляем false для продакшн
| APP_URL                   | http://localhost | Url-адрес приложения
| APP_KEY                   |                  | Уникальная строка из 32 случайных символов, обязательно установить перед развертыванием в продакшн

## Параметры встроенного сервера авторизации

Приложение в базовой версии имеет встроенный сервер авторизации использующий [JWT](https://jwt.io/).

| Параметр                                     | По умолчанию | Описание
| -------------------------------------------- | ------------ | --------
| AUTHORIZATION_SERVER_ENABLED                 | true         | Включает встроенный сервер авторизации
| AUTHORIZATION_SERVER_PUBLIC_KEY              | public.pem   | Полный путь к файлу с публичным ключом сервера авторизации
| AUTHORIZATION_SERVER_PRIVATE_KEY             | private.pem  | Полный путь к файлу с приватным ключом сервера авторизации
| AUTHORIZATION_SERVER_GRANT_CODE_ENABLED      | true         | Включает возможность авторизации по одноразовому паролю из письма (при включенном встроенном сервере авторизации)
| AUTHORIZATION_SERVER_GRANT_CODE_LENGTH       | 6            | Длина генерируемого одноразового пароля
| AUTHORIZATION_SERVER_GRANT_CODE_LIFETIME     | 600          | Время жизни одноразового пароля в секундах
| AUTHORIZATION_SERVER_GRANT_CODE_ATTEMPTS_MAX | 5            | Максимальное количество попыток ввода одноразового пароля
| AUTHORIZATION_SERVER_GRANT_REFRESH_ENABLED   | true         | Включает возможность обновления токена
| AUTHORIZATION_SERVER_TOKEN_ALGORITHM         | RS256        | Алгоритм шифрования токена авторизации
| AUTHORIZATION_SERVER_TOKEN_ACCESS_LIFETIME   | 600          | Время жизни access-токена в секундах, не рекомендуется устанавливать время жизни больше 10 минут
| AUTHORIZATION_SERVER_TOKEN_REFRESH_LIFETIME  | 600          | Время жизни refresh-токена в секундах, рекомендуется устанавливать равным времени жизни access-токена

## Параметры подключения к базе данных

Приложение в базовой версии расчитано на работу с [Postgresql](https://www.postgresql.org/).

| Параметр                  | По умолчанию     | Описание
| --------------------------| ---------------- | --------
| INVESTOR_TESTING_CHARSET  | utf8             | Кодировка при подключении к базе данных
| INVESTOR_TESTING_DATABASE | investor_testing | Имя базы данных
| INVESTOR_TESTING_HOST     | localhost        | Хост для подключения к базе данных
| INVESTOR_TESTING_PORT     | 5432             | Порт для подключения к базе данных
| INVESTOR_TESTING_SCHEMA   | public           | Имя схемы при подключнии к базе данных
| INVESTOR_TESTING_TIMEZONE | UTC              | Часовой пояс при подключении к базе данных
| INVESTOR_TESTING_USERNAME |                  | Имя пользователя при подключении к базе данных
| INVESTOR_TESTING_PASSWORD |                  | Пароль при подключении к базе данных

## Настройки почтового клиента

Приложение в базовой версии отправляет письма при помощи [SMTP](https://ru.wikipedia.org/wiki/SMTP).
Подробнее о возможных опциях отправки писем можно прочитать в [документации фреймворка](https://lumen.laravel.com/docs/8.x/mail).

| Параметр          | По умолчанию         | Описание
| ------------------| -------------------- | --------
| MAIL_HOST         | smtp.mailgun.org     | Хост для подключения к SMTP-серверу
| MAIL_PORT         | 587                  | Порт для подключения к SMTP-серверу
| MAIL_ENCRYPTION   | tls                  | Протокол шифрования при подключении к SMTP-серверу
| MAIL_USERNAME     |                      | Имя пользователя при подключении к SMTP-серверу
| MAIL_PASSWORD     |                      | Пароль при подключении к SMTP-серверу
| MAIL_FROM_ADDRESS | hello@example.com    | Адрес, от которого приходят письма
| MAIL_FROM_NAME    | Example              | Имя отправителя

Можно также ознакомиться с базовой конфигурацией приложения в [документации фреймворка](https://lumen.laravel.com/docs/8.x).

## Содержание письма

| Параметр                     | По умолчанию        | Описание
|------------------------------| --------------------| --------
| INVESTOR_TESTING_BROKER_NAME | "Ньютон технологии" | Название компании в тексте письма о резульатах прохождения теста

# Работа с данными

## Загрузка данных

Демо-данные в формате `csv` находятся в директории `./resources/demodata`, для заполнения
таблиц данными необходимо последовательно загрузить: категории, вопросы, ответы.

### Загрузка категорий

Демо-данные со списком категорий находятся в файле `./resources/demodata/categories.csv`.

| Имя поля          | Описание
| ------------------| --------
| code              | Код категории
| name              | Имя категории
| description       | Описание категории
| description_short | Краткое описание категории
| status            | Статус категории (`enabled` - категория активна; `disabled` - категория отключена)

Команда загрузки категорий (выполняется из корневой директории приложения):

```
$ php artisan import categories ./resources/demodata/categories.csv
```

### Загрузка вопросов

Демо-данные со списком вопросов находятся в файле `./resources/demodata/questions.csv`.

| Имя поля                    | Описание
| ----------------------------| --------
| id                          | Идентификатор вопроса
| group_code                  | Код группы вопросов (`evaluation` - самооценка; `knowledge` - знания; `custom` - произвольные вопросы)
| category_code               | Код категории
| text                        | Текст вопроса
| answers_count_min           | Минимальное количество предлагаемых вариантов ответа
| answers_count_max           | Максимальное количество предлагаемых вариантов ответа
| answers_count_to_choose_min | Минимально допустимое к выбору количество ответов
| answers_count_to_choose_max | Максимально допустимое к выбору количество ответов (если не заполнять, то можно будет выбрать любое количество ответов большее чем `answers_count_to_choose_min`)
| weight                      | Вес вопроса
| status                      | Статус вопроса (`enabled` - может быть предложен; `disabled` - не может быть предложен)

Команда загрузки вопросов (выполняется из корневой директории приложения):

```
$ php artisan import questions ./resources/demodata/questions.csv
```

### Загрузка вариантов ответа

Демо-данные со списком вариантов ответа находятся в файле `./resources/demodata/answers.csv`.

| Имя поля    | Описание
| ------------| --------
| question_id | Идентификатор вопроса
| text        | Текст ответа
| correct     | Признак правильности ответа (`1` - ответ правильный; `2` - ответ неправильный; ` ` - пустое значение соответствует ответу, который не является правильным или неправильным, актуально для ответов на вопросы блока самооценки)
| sort        | Вес при сортировке предлагаемых вариантов ответа, от меньшего к большему
| status      | Статус ответа (`enabled` - может быть предложен; `required` - должен быть предложен; `disabled` - не может быть предложен). Не нужно ставить `required` на ответы с `correct=1`, так как корректные ответы со статусом `enabled` предлагаются всегда. Статус `required` позволяет, к примеру, всегда включать в предлагаемые варианты ответ `Ни один из ответов не является правильным`.

Команда загрузки ответов (выполняется из корневой директории приложения):

```
$ php artisan import answers ./resources/demodata/answers.csv
```

## Выгрузка данных

В приложение добавлена команда для выгрузки результатов прохождения тестов по категориям в формате `csv`.
Выгружаются только тесты в статусах `passed` (пройден) и `processing` (пройден, результат обрабатывается внешней системой).

| Имя поля   | Описание
| -----------| --------
| user_id    | Идентификатор пользователя
| email      | Email-адрес пользователя
| category   | Код категории
| status     | Статус теста
| updated_at | Время обновления теста

```
$ php artisan export /tmp/fileName.csv
```

# Добавление учетной записи администратора

Для доступа в панель администрирования можно использовать существующую учетную запись,
создав для нее пароль и добавив роль `admin`.

## Создание учетной записи с паролем

Если при выполнении команды создания пароля учетная запись не найдена, то система предложит такую запись создать.

```
$ php artisan user:password:add test@exanple.com

 Создать пользователя с логином test@exanple.com? (yes/no) [no]:
 > yes

 Пароль для пользователя test@exanple.com::
 > 

```

Удалить возможность входа по паролю можно следующей командой:

```
$ php artisan user:password:remove test@exanple.com
```

## Добавление роли администратора

Добавить роль администратора к существующей учетной записи можно при помощи следующей команды:

```
$ php artisan user:role:add test@exanple.com admin
```

Убрать у пользователя роль администратора можно при помощи следующей команды:

```
$ php artisan user:role:remove test@exanple.com admin
```

# Разработка плагинов

Сервис позволяет расширять или менять функционал через добавление плагинов.
Плагины помогут подключить собственные системы авторизации, настроить интеграцию
с существующими backoffice-системами брокера. Через плагины можно также организовать
горизонтальное масштабирование базы данных, переключиться на альтернативные источники
хранения данных (MySQL, HttpRepository, etc.), добавить дополнительные этапы проверки
результатов тестирования и многое другое.

Далее описаны принципы разработки и подключения плагинов. Плагины могут быть разработаны
собственными силами брокера, либо вы можете обратиться в компанию [Ньютон Технологии](https://nwtn.io/)
и наша команда поможет организовать процесс интеграции и написания плагинов.

## Основы и необходимая экспертиза

Бекенд приложения написан с использованием фреймворка [Lumen](https://lumen.laravel.com/).
Любой плагин представляет из себя [Service Provider](https://lumen.laravel.com/docs/8.x/providers),
подключаемый в приложение.

В плагине можно изменять или добавлять новую конфигурацию. Добавлять новые роуты,
заменять репозитории и сущности приложения своими используя механизм
dependency injection из [Service Container](https://lumen.laravel.com/docs/8.x/container).

## Подключение плагинов

Любой плагин должен наследоваться от базового класса `Plugins\Plugin`. Подключение плагинов осуществляется
через создание файла `plugins/plugins.php`, из которого возвращается массив подключаемых плагинов:

```
<?php

return [
    Plugins\MyCompany\MyExamplePlugin::class,
];
```

## Примеры плагинов

Примеры плагинов можно посмотреть в директории `/plugins/Example`:

- **ExampleField** - плагин добавляет ссылку на логотип категории в ответы методов `GET /categories`.
- **ExampleLetter** - плагин отправляет приветственное письмо при регистрации пользователя.
- **ExampleRoute** - плагин добавляет в приложение новый метод API, возвращающий
значение из нового конфигурационного файла.
- **ExampleView** - плагин изменяет шаблон письма с кодом авторизации пользователя.
- **ExampleTestResultView** - плагин изменяет шаблон письма с результатом тестирования инвестора.
